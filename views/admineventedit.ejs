<!DOCTYPE html>
<html>
	<head>
		<% include head_html %>
		<script src="/javascripts/priceEditor.js"></script>
	</head>
	<body>
		<div class="wrapper">
			<% if(adminLogin){ %>
				<div class="sidebar" data-color="purple" data-background-color="white" data-image="../assets/img/sidebar-1.jpg">
					<% include admmnu %>
				</div>
				<div id="workArea" class="main-panel">
					<nav class="navbar navbar-expand-lg navbar-transparent navbar-absolute fixed-top ">
						<div class="container-fluid">
							<button class="navbar-toggler" type="button" data-toggle="collapse" aria-controls="navigation-index" aria-expanded="false" aria-label="Toggle navigation">
							<span class="sr-only">Toggle navigation</span>
							<span class="navbar-toggler-icon icon-bar"></span>
							<span class="navbar-toggler-icon icon-bar"></span>
							<span class="navbar-toggler-icon icon-bar"></span>
							</button>
							<div class="collapse navbar-collapse justify-content-end">
								<ul class="navbar-nav">
									<% include admheader %>
								</ul>
							</div>
						</div>
					</nav>
					<div id="workArea" class="content">
						<div class="container-fluid">
							<div class="col-md-12">
								<h2>Редактирование мероприятия</h2>
								<!-- ТЕСТ -->
								<div style="display: none;">test</div>
								<!-- ТЕСТ -->
							</div>
							<div class="col-md-12">
								<div class="card">
									<div class="card-body">
										<form name="formEvent">
											
											<!-- <%= eventData[0].ID %> -->
											<% eventData.forEach(function(eventRow) { %>
												<div class="col-md-3">
													<p><label>ID: </label> <span id="eventID" data-value="<%= eventRow.ID %>"><%= eventRow.ID %></span></p>
													<% if(eventRow.IDTemplate){ %>
														<p>
															<label>ID шаблона билета: </label> 
															<span id="eventID" data-value="<%= eventRow.ID %>"><%= eventRow.IDTemplate %></span>
															<a href="/admin/get/template/<%= eventRow.IDTemplate %>" target="_blank">Предпросмотр</a>
														</p>
													<% } %>

													<!-- <p><label>Текущий статус: </label> <span id="eventIDStatus" data-value="<%= eventRow.IDStatus %>"><%= eventRow.StatusName %></span></p> -->
													<div class="form-group">
														<label for="eventName">Наименование:</label>
														<input type="text" class="form-control" id="eventName" value="<%= eventRow.Name %>" placeholder="название мероприятия" />
													</div>
													<div class="form-group">
														<label for="eventTickets">Ограничение билетов:</label>
														<input type="text" class="form-control" id="eventTickets" value="<%= eventRow.MaxTickets %>" placeholder="Максимальное количество возможно проданных билетов" />
													</div>
													<div class="form-group">
														<label for="eventDateFrom">Начало:</label>
														<input type="datetime-local" class="form-control" id="eventDateFrom" value="<%= eventRow.DateFrom %>" placeholder="начало" />
													</div>

													
													<!--
													<div class="form-group">
														<label for="eventDateTo">Окончание:</label>
														<input type="datetime-local" class="form-control" id="eventDateTo" value="<%= eventRow.Dateto %>" placeholder="конец">
													</div>
													-->
													<div class="form-group">
														<label for="stadiumsList">Шаблон билета:</label>
														<span id="eventIDTemplate" data-value="<%= eventRow.IDTemplate %>" hidden><%= eventRow.IDTemplate %></span>
														<select name="templatesList" id="templatesList" class="form-control form-control-sm">
															<% templates.forEach(function(template) { %>
																<% if (template.ID == eventRow.IDTemplate ){ %>
																	<option value="<%= template.ID %>" selected><%= template.templateName %> (ID:<%= template.ID %>) - Выбрано</option>
																<% }else{ %>
																	<option value="<%= template.ID %>"><%= template.templateName %> (ID:<%= template.ID %>)</option>
																<% } %>
															<% }); %>
														</select>
													</div>
													<div class="form-group">
														<label for="stadiumsList">Стадион:</label>
														<span id="eventIDStadium" data-value="<%= eventRow.IDStadium %>" hidden><%= eventRow.IDStadium %></span>
														<select name="stadiumsList" id="stadiumsList" class="form-control form-control-sm">
															<option value="<%= eventRow.IDStadium %>" selected><%= eventRow.Stadium %></option>
															<% stadiums.forEach(function(stadiumRow) { %>
																<% if (stadiumRow.ID != eventRow.IDStadium ){ %>
																	<option value="<%= stadiumRow.ID %>"><%= stadiumRow.Name %></option>
																<% } %>
															<% }); %>
														</select>
													</div>

													<div class="form-group">
														<button class="btn btn-primary pricecolor" type="button">Изменение цвета мест</button>
													</div>
												
													<div class="form-group">
														<% if (eventRow.ShowOnline) { %>
															<input type="checkbox" id="eventShowOnline" checked>Показать online</input>
														<% } else { %>
															<input type="checkbox" id="eventShowOnline">Показать online</input>
														<% } %>
													</div>
													<div class="form-group">
														<% if (eventRow.ShowCasher) { %>
															<input type="checkbox" id="eventShowCasher" checked>Показать кассиру</input>
														<% } else { %>
															<input type="checkbox" id="eventShowCasher">Показать кассиру</input>
														<% } %>
													</div>
													<div class="form-group">
														<% if (eventRow.ShowAPI) { %>
															<input type="checkbox" id="eventShowAPI" checked>Показать для API</input>
														<% } else { %>
															<input type="checkbox" id="eventShowAPI">Показать для API</input>
														<% } %>
													</div>
													<!--<div class="form-group">
														<button type="button" id="btnGenerateTickets" onclick="GenerateTickets();">Генерация билетов</button>
														<p id="GenerateTicketsMSG"></p>
													</div>-->
												</div>
												<div class="col-sm-6 col-md-4">
													<div class="form-group">
														<label for="eventImage">Афиша:</label>
														<input type="file" id="eventImageFile" name="eventImageFile" style="display: none;" />
														<button class="btn btn-primary" type="button" onclick="ClickNewImg();">Сменить</button>
														<p id="eventImgMsg"></p>
														<img id="eventImage" name="eventImage" src="<%= eventRow.ImgPath %>" alt="afisha" width="250" height="350" />
													</div>
												</div>
											<% }); %>
										</form>
									</div>
								</div>
							</div>
							<div class="col-md-12">
								<h2>Назначение цен на билеты</h2>
							</div>
							<div class="col-md-12">
								<div class="card">
									<div class="card-body">
										<form name="formPrice">
												<div class="col-md-8">
													<div class="table-responsive">
														<table class="table trans">
															<thead class="text-primary">
																<tr>
																	<th>Сектор</th>
																	<th>Цена</th>
																	<th>Ряд</th>
																</tr>
															</thead>
															<tbody>
																<% if(sectors){ %>
																	<% sectors.forEach(function(seatRow) { %>
																		<tr class="clickable-row">
																			<td data-id="<%= seatRow.SectorName %>"><%= seatRow.SectorName %></td>
																			<td class="cell-price-input">
																				<input type="text" name="txPrice" class="priceInput form-control" value="<%= seatRow.Price %>"	 />
																			</td>
																			<td>

																				<select name="rowN" class="select-rowN form-control selectpicker" data-style="btn btn-link">
																					<% rownums[seatRow.SectorName].forEach(function(Row) { %>
																						<option value='{"rowN": <%= Row.RowN %>, "price": <%= Row.Price || "Ошибка" %>}'><%= Row.RowN %> ( <%= Row.Price || "Ошибка" %> )</option>
																					<% }); %>
																				</select>
																			</td>
																		</tr>
																	<% }); %>
																<% } %>
															</tbody>
														</table>
													</div>
												</div>
												<!-- <div class="col-md-2">
													<button type="button" id="savePrice">Сохранить цену</button>
												</div> -->
											</form>
									</div>
								</div>
							</div>
							<div class="form-group">
								<button type="button" class="btn btn-primary" id="btnDeleteEvent" name="btnDeleteEvent" value="DeleteEventClick">Отменить</button>
								<button type="button" class="btn btn-primary" id="btnSaveEvent" name="btnSaveEvent" value="SaveEventClick">Сохранить</button>
								<p id="txResultMsg"></p>
								<!-- HTML-код модального окна -->
								<div id="myModalBox" class="modal fade">
								  <div class="modal-dialog">
								    <div class="modal-content">
								      <!-- Заголовок модального окна -->
								      <div class="modal-header">
								      	<h4 class="modal-title">Подтверждение действия</h4>
								        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
								      </div>
								      <!-- Основное содержимое модального окна -->
								      <div class="modal-body">
								        <!-- Вы действительно хотите удалить мероприятие? -->
								        Выйти без сохранения изменений?
								      </div>
								      <!-- Футер модального окна -->
								      <div class="modal-footer">
								        
								        <button type="button" class="btn btn-danger" id="deleteExecute">Да</button>
								        <button type="button" class="btn btn-default" data-dismiss="modal">Нет</button>
								      </div>
								    </div>
								  </div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div id="colorModal" class="modal fade">
				    <div class="modal-dialog">
					    <div class="modal-content">
					      <!-- Заголовок модального окна -->
					      <div class="modal-header">
					      	<h4 class="modal-title">Изменение цвета мест</h4>
					        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
					      </div>
					      <!-- Основное содержимое модального окна -->
					      <div class="modal-body">
					      	<div class="row justify-content-center" style="margin-bottom: 10px;">
					      		<div class="col-3">
					      			<button class="btn btn-success modal-add-price" style="font-size: 8px;">
					      				<i class="fa fa-plus fa-1" aria-hidden="true"></i>
					      			</button>
					      		</div>
					        </div>
					        <form class="colorsdata">
					        	<% priceColor.forEach(function(item) { %>
									<div class="row justify-content-center" name="colorItem">
							        	<div class="col-4">
							        		<input type="number" class="form-control" value="<%= item.Price %>" readonly name="price">
							        	</div>
							        	<div class="col-1" style="margin-top: 5px;">
							        		<input type="color" style="width: 30px; height: 30px;" value="<%= item.Color %>" name="color">
							        	</div> 	
							        </div>
					        	<% }) %>
					      
					        </form>
					       
					      </div>
					      <!-- Футер модального окна -->
					      <div class="modal-footer">
					        
					        <button type="button" class="btn btn-success colorSave">Сохранить</button>
					        <button type="button" class="btn btn-default" data-dismiss="modal">Выйти</button>
					      </div>
					    </div>
				    </div>
				</div>
				<script>
					$(document).ready(function(){
						GetStadiumList();
					});

					function GetStadiumList(){
						$.ajax({
							url: '/admin/stadiumsJson',
							type: "GET",
							success: function(result){
								$('select#stadiumsList').empty();
								var nEvIDStadium = $("#eventIDStadium").data("value");
								$.each(result, function(index) {
									if (result[index].ID == nEvIDStadium) {
										$('select#stadiumsList').append(
											$('<option selected></option>')
												.val(result[index].ID)
												.html(result[index].Name)
										);
									}
									else {
										$('select#stadiumsList').append(
												$('<option></option>')
												.val(result[index].ID)
												.html(result[index].Name)
										);
									}
								});
							}
						});
					};

					$('.pricecolor').click(function(){
						$('#colorModal').modal('show');
					})
					$('.modal-add-price').click(function(){
						var htmlData = `<div class="row justify-content-center" name="colorItem">
								        	<div class="col-4">
								        		<input type="number" class="form-control" value="1000" name="price">
								        	</div>
								        	<div class="col-1" style="margin-top: 5px;">
								        		<input type="color" style="width: 30px; height: 30px;" name="color">
								        	</div> 	
								        </div>`;
						$('.colorsdata').append(htmlData);
					})
					$('.colorsdata').on('change', '.price-new', function(){
						console.log(this)
					})
					$('.colorSave').click(function(){

						var colors = $('.colorsdata').serializeArray();
						console.log(colors)

						let colorsNew = [];
						for(var i = 0; i < colors.length; i = i + 2){
							colorsNew.push({
								price: colors[i].value,
								color: colors[i+1].value
							})
						}
						let data = {
							IDEvent: $("#eventID").data("value"),
							items: JSON.stringify(colorsNew)
						}
						console.log(data);
							//---------------
						$.post('/admin/colors/modify', data, function(ans){
							console.log(ans);
						})
						// $.ajax({
						// 	url: '/admin/colors/modify/',
						// 	type: "POST",
						// 	dataType: 'json',
						// 	data: JSON.stringify(data),
						// 	success: function(result){
						// 		console.log(result);

						// 	},
						// 	error: function(err){
						// 		console.log(err);
						// 	}
						// });
					})

					$("#btnSaveEvent").on('click', function(){
						var nEventID = 0;
						nEventID = $("#eventID").data("value");
						//console.log("btnSaveEvent click: nEventID="+nEventID);

						var sURL = "/admin/event/"+nEventID;

						//console.log('img src='+$('#eventImage').attr('src'));
						//console.log('eventShowOnline='+$("input[id='eventShowOnline']:checked").val());
						//console.log('eventShowCasher='+$("input[id='eventShowCasher']:checked").val());
						//console.log('eventShowAPI='+$("input[id='eventShowAPI']:checked").val());

						//---------------
						var sShowOnline = "false";
						if ($("input[id='eventShowOnline']:checked").val() === "undefined") {
							sShowOnline = "false";
						}
						else
						if (($("input[id='eventShowOnline']:checked").val() == "true")
							|| ($("input[id='eventShowOnline']:checked").val() == "on")) {
							sShowOnline = "true";
						}
						else {sShowOnline = "false";}

						//---------------
						var sShowCasher = "false";
						if ($("input[id='eventShowCasher']:checked").val() === "undefined") {
							sShowCasher = "false";
						}
						else
						if (($("input[id='eventShowCasher']:checked").val() == "true")
							|| ($("input[id='eventShowCasher']:checked").val() == "on")){
							sShowCasher = "true";
						}
						else {sShowCasher = "false";}

						//---------------
						var sShowAPI = "false";
						if (($("input[id='eventShowAPI']:checked").val() === "undefined")
							|| ($("input[id='eventShowAPI']:checked").val() == "true")) {
							sShowAPI = "false";
						}
						else
						if ($("input[id='eventShowAPI']:checked").val() == "on") {
							sShowAPI = "true";
						}
						else {sShowAPI = "false";}

						//---------------
						$.ajax({
							url: sURL,
							type: "POST",
							data: {
								postOperation: 'upd',
								eventID: $("#eventID").val(),
								eventName: $("#eventName").val(),
								eventDateFrom: $("#eventDateFrom").val(),
								stadiumID: $("select#stadiumsList").val(),
								templateID: $("select#templatesList").val(),
								eventAfisha: $('#eventImage').attr('src'),
								showOnline: sShowOnline,
								showCasher: sShowCasher,
								showAPI: sShowAPI,
								MaxTickets: $('#eventTickets').val()
							},
							success: function(result){
								console.log("POST upd /admin/event/id success: result="+result);
								$("#txResultMsg").html(result);
								ClearMsg("#txResultMsg");
								//TODO: refresh page

							},
							error: function(err){
								console.log("POST /admin/event/id error:");
								console.log(err);
							}
						});
					});

					$("#btnDeleteEvent").on('click', function(){
						$("#myModalBox").modal('show');
					});
					$('#deleteExecute').on('click', function(){
						document.location.href = "/admin/events";
						// var nEventID = 0;
						// nEventID = $("#eventID").data("value");
						// console.log("btnDeleteEvent click: nEventID="+nEventID);
						// $.ajax({
						// 	url: "/admin/event/"+nEventID,
						// 	type: "POST",
						// 	data: {
						// 		postOperation: 'del',
						// 		eventID: $("#eventID").val(),
						// 		eventName: $("#eventName").val(),
						// 		eventDateFrom: $("#eventDateFrom").val(),
						// 		stadiumID: $("select#stadiumsList").val(),
						// 		eventAfisha: $('#eventImage').attr('src')
						// 		},
						// 	success: function(result){
						// 			console.log("POST del /admin/event/id success: result="+result);
						// 			$("#txResultMsg").html(result);
						// 			window.location = '/admin/events';
						// 			//--------------
						// 			//TODO: after development this functional we must delete this command:
						// 			ClearMsg("#txResultMsg");
						// 			//--------------
						// 			GetActualEventStatus();
						// 		},
						// 	error: function(err){
						// 		console.log("POST /admin/event/id error:");
						// 		console.log(err);
						// 	}
						// });
					})

					$('#rowsTable').on('click', '.clickable-row', function(event) {
					  //$(this).addClass('active').siblings().removeClass('active');
					  if($(this).hasClass('active')){
						$(this).removeClass('active');
					  } else {
						$(this).addClass('active').siblings().removeClass('active');
					  }
					});

					function readURL(input) {

					    if (input.files && input.files[0]) {
					        var reader = new FileReader();

					        reader.onload = function (e) {
					            $('#eventImage').attr('src', e.target.result);
					        };

					        reader.readAsDataURL(input.files[0]);
					    }
					}

					$("#eventImageFile").change(function(evt){
					    //readURL(this);

					    var sImgFileName = evt.target.files[0].name;
						let file = $('#eventImageFile').get(0).files;
						console.log('ClickNewImg:: sImgFileName='+sImgFileName);
						//$("#eventImgMsg").html("Смена картинки - в разработке");
						//--------------
						//TODO: after development this functional we must delete this command:
						//ClearMsg("#eventImgMsg");
						//--------------
						var nEventID = $("#eventID").data("value");

						var data = new FormData();

						data.append('img', $('#eventImageFile')[0].files[0]);

						$.ajax({
							url: "/admin/uploadeventimg",
							data: data,
							cache: false,
							contentType: false,
							processData: false,
							method: 'POST',
							//type: 'POST', // For jQuery < 1.9
							success: function(result){
								console.log(result);
								console.log("POST /admin/uploadeventimg success: result=");
								$('#eventImage').attr('src', '/images/events/'+sImgFileName);
								console.log('ClickNewImg2:: sImgFileName='+sImgFileName);
							},
							error: function(err){
								console.log("POST /admin/uploadeventimg error:");
								console.log(err);
							}
						});
					});
					
					function GetActualEventStatus(){
						console.log('GetActualEventStatus::');
						var nEventID = $("#eventID").data("value");
						$.ajax({
							url: "/admin/eventGetStatus/"+nEventID,
							type: "GET",
							success: function(result){
									console.log('GetActualEventStatus success:');
									console.log(result);
									$("#eventIDStatus").attr('data-value', result[0].IDStatus);
									$("#eventIDStatus").html(result[0].StatusName);
								},
							error: function(err){
								console.log("GET GetActualEventStatus /admin/eventGetStatus/id error:");
								console.log(err);
							}
						});
					}

					function ClickNewImg(){
						$("input[id='eventImageFile']").click();
					};
				

					function ClearMsg(msgElement){
						window.setTimeout( function(){
							$(msgElement).html("");
						}, 5000 );
					}
				</script>
			<% } else { %>
				<% include admloginform %>
			<% } %>
		</div>
	</body>
</html>

